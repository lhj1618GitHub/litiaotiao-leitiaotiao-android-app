<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GKD自定义规则生成工具</title>
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3d3d3d;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent: #4f46e5;
            --accent-hover: #4338ca;
            --success: #10b981;
            --error: #ef4444;
            --border: #404040;
        }
        
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', system-ui, sans-serif; 
        }
        
        body { 
            background: var(--bg-primary); 
            color: var(--text-primary);
            min-height: 100vh; 
            padding: 12px;
            line-height: 1.5;
        }
        
        .container { 
            max-width: 100%; 
            margin: 0 auto; 
            background: var(--bg-secondary); 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
            overflow: hidden;
        }
        
        header { 
            background: var(--accent); 
            color: white; 
            padding: 20px; 
        }
        
        h1 { 
            font-size: 22px; 
            margin-bottom: 6px; 
            font-weight: 600;
        }
        
        .subtitle { 
            opacity: 0.9; 
            font-size: 14px; 
        }
        
        .app-body { 
            display: flex; 
            flex-direction: column;
            min-height: 400px; 
        }
        
        @media (min-width: 768px) {
            .app-body {
                flex-direction: row;
            }
        }
        
        .config-panel { 
            flex: 1; 
            padding: 20px; 
            background: var(--bg-secondary); 
            border-bottom: 1px solid var(--border);
        }
        
        @media (min-width: 768px) {
            .config-panel {
                border-bottom: none;
                border-right: 1px solid var(--border);
            }
        }
        
        .preview-panel { 
            flex: 1; 
            padding: 20px; 
            display: flex; 
            flex-direction: column;
            min-height: 400px;
        }
        
        h2 { 
            font-size: 18px; 
            margin-bottom: 16px; 
            color: var(--text-primary); 
            border-left: 3px solid var(--accent); 
            padding-left: 10px;
            font-weight: 600;
        }
        
        .tabs { 
            display: flex; 
            border-bottom: 1px solid var(--border); 
            margin-bottom: 16px; 
            overflow-x: auto;
        }
        
        .tab { 
            padding: 8px 16px; 
            cursor: pointer; 
            border-bottom: 2px solid transparent; 
            white-space: nowrap;
            font-size: 14px;
        }
        
        .tab.active { 
            border-bottom-color: var(--accent); 
            color: var(--accent); 
            font-weight: 600; 
        }
        
        .tab-content { 
            display: none; 
        }
        
        .tab-content.active { 
            display: block; 
        }
        
        .form-group { 
            margin-bottom: 16px; 
            position: relative;
        }
        
        label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 600; 
            color: var(--text-secondary); 
            font-size: 13px; 
        }
        
        input, select, textarea { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            font-size: 14px; 
            transition: all 0.2s; 
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: var(--accent); 
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); 
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn { 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 10px 16px; 
            border-radius: 6px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            flex: 1;
        }
        
        .btn:hover { 
            background: var(--accent-hover); 
            transform: translateY(-1px); 
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-copy {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }
        
        .btn-copy:hover {
            background: var(--bg-primary);
        }
        
        .btn-deconstruct {
            background: #f59e0b;
        }
        
        .btn-deconstruct:hover {
            background: #d97706;
        }
        
        .btn-paste {
            background: #10b981;
            flex: none;
            width: auto;
            margin-left: 10px;
        }
        
        .btn-paste:hover {
            background: #0da271;
        }
        
        .btn-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn-clear:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }
        
        .input-with-clear {
            position: relative;
        }
        
        .input-with-clear input,
        .input-with-clear textarea {
            padding-right: 30px;
        }
        
        .output-area { 
            flex: 1; 
            background: #0d1117; 
            color: #e2e8f0; 
            border-radius: 6px; 
            padding: 16px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 13px; 
            line-height: 1.4; 
            white-space: pre-wrap; 
            overflow-y: auto; 
            margin-bottom: 16px;
            border: 1px solid var(--border);
            min-height: 200px;
        }
        
        .output-line { 
            margin-bottom: 4px; 
        }
        
        .field-name { 
            color: #7dd3fc; 
        }
        
        .field-value { 
            color: #fbbf24; 
        }
        
        .field-comment { 
            color: #34d399; 
            font-style: italic; 
        }
        
        .match-rule { 
            background: var(--bg-tertiary); 
            padding: 12px; 
            border-radius: 6px; 
            margin-bottom: 12px; 
            border: 1px solid var(--border);
        }
        
        .match-header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
        }
        
        .match-title { 
            font-weight: 600; 
            font-size: 14px;
        }
        
        .remove-match { 
            color: var(--error); 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .remove-match:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .helper-text { 
            font-size: 12px; 
            color: var(--text-secondary); 
            margin-top: 4px; 
        }
        
        .deconstruct-example {
            background: var(--bg-primary);
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 12px;
            border-left: 3px solid #f59e0b;
        }
        
        .paste-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .paste-area textarea {
            flex: 1;
            min-height: 150px;
            height: auto;
            resize: vertical;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast.error {
            background: var(--error);
        }
        
        .preview-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .help-content {
            padding: 20px;
        }
        
        .example {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 10px;
            border-left: 3px solid var(--accent);
        }
        
        /* 确保只有规则拆解标签页有粘贴按钮 */
        #basic .btn-paste,
        #matches .btn-paste,
        #advanced .btn-paste,
        #preview .btn-paste,
        #help .btn-paste {
            display: none !important;
        }
        
        #deconstruct .btn-paste {
            display: inline-flex !important;
        }
        
        /* 规则拆解页面自适应调整 */
        #deconstruct .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        #deconstruct .paste-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        #deconstruct .paste-area textarea {
            flex: 1;
            min-height: 150px;
            height: auto;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>GKD自定义规则生成工具</h1>
            <div class="subtitle">无需学习复杂语法，简单填写表单即可生成完整的GKD规则</div>
        </header>
        
        <div class="app-body">
            <div class="config-panel">
                <h2>规则配置</h2>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('basic')">基本设置</div>
                    <div class="tab" onclick="switchTab('matches')">匹配规则</div>
                    <div class="tab" onclick="switchTab('advanced')">高级设置</div>
                    <div class="tab" onclick="switchTab('preview')">规则预览</div>
                    <div class="tab" onclick="switchTab('deconstruct')">规则拆解</div>
                    <div class="tab" onclick="switchTab('help')">使用说明</div>
                </div>
                
                <!-- 基本设置标签页 - 只包含基本设置 -->
                <div id="basic" class="tab-content active">
                    <div class="form-group">
                        <label for="appId">应用包名 (appId)</label>
                        <div class="input-with-clear">
                            <input type="text" id="appId" placeholder="例如: com.tencent.mm">
                            <button class="btn-clear" onclick="clearInput('appId')">×</button>
                        </div>
                        <div class="helper-text">需要跳广告的应用包名，可在快照中查看</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ruleName">规则名称 (name)</label>
                        <div class="input-with-clear">
                            <input type="text" id="ruleName" placeholder="例如: 开屏广告">
                            <button class="btn-clear" onclick="clearInput('ruleName')">×</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="groupKey">规则组标识 (key)</label>
                        <div class="input-with-clear">
                            <input type="number" id="groupKey" value="1" min="1">
                            <button class="btn-clear" onclick="clearInput('groupKey')">×</button>
                        </div>
                        <div class="helper-text">同一应用内不同规则组的唯一标识</div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn" onclick="nextTab()">下一步</button>
                    </div>
                </div>
                
                <!-- 匹配规则标签页 - 只包含匹配规则 -->
                <div id="matches" class="tab-content">
                    <div id="match-rules">
                        <div class="match-rule">
                            <div class="match-header">
                                <div class="match-title">匹配规则 #1</div>
                                <button class="remove-match" onclick="removeMatchRule(this)">删除</button>
                            </div>
                            <div class="form-group">
                                <label>匹配类型</label>
                                <select class="match-type" onchange="updateMatchHelper(this)">
                                    <option value="id">ID匹配</option>
                                    <option value="text">文本匹配</option>
                                    <option value="desc">描述匹配</option>
                                    <option value="complex">复合匹配</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>匹配值</label>
                                <div class="input-with-clear">
                                    <input type="text" class="match-value" placeholder="根据匹配类型填写ID、文本或描述">
                                    <button class="btn-clear" onclick="clearMatchValue(this)">×</button>
                                </div>
                                <div class="helper-text match-helper">匹配元素的资源ID，如: com.example.ad/close</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn" onclick="addMatchRule()" style="flex: none; width: auto;">+ 添加匹配规则</button>
                    
                    <div class="button-group">
                        <button class="btn" onclick="nextTab()">下一步</button>
                    </div>
                </div>
                
                <!-- 高级设置标签页 - 只包含高级设置 -->
                <div id="advanced" class="tab-content">
                    <div class="form-group">
                        <label for="activityIds">活动页面 (activityIds)</label>
                        <div class="input-with-clear">
                            <textarea id="activityIds" placeholder="每行一个activityId，留空则全局匹配" rows="3"></textarea>
                            <button class="btn-clear" onclick="clearInput('activityIds')">×</button>
                        </div>
                        <div class="helper-text">指定规则生效的页面，可在快照中查看</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="actionDelay">延迟执行 (actionDelay)</label>
                        <div class="input-with-clear">
                            <input type="number" id="actionDelay" value="0" min="0">
                            <button class="btn-clear" onclick="clearInput('actionDelay')">×</button>
                        </div>
                        <div class="helper-text">单位毫秒，用于控制规则执行时机</div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn" onclick="nextTab()">下一步</button>
                    </div>
                </div>
                
                <!-- 规则预览标签页 - 只包含规则预览 -->
                <div id="preview" class="tab-content">
                    <div class="preview-content">
                        <h2>规则预览</h2>
                        <div class="output-area" id="preview-output">
                            <div class="output-line">// 生成的规则将在此处预览...</div>
                            <div class="output-line">// 1. 填写左侧表单中的规则信息</div>
                            <div class="output-line">// 2. 点击"生成GKD规则"按钮</div>
                        </div>
                        <div class="button-group">
                            <button class="btn" onclick="generateRule()">生成规则</button>
                            <button class="btn btn-copy" onclick="copyPreviewRule()">复制预览规则</button>
                        </div>
                    </div>
                </div>
                
                <!-- 规则拆解标签页 - 只包含规则拆解内容，粘贴按钮只在这里出现 -->
                <div id="deconstruct" class="tab-content">
                    <div class="form-group">
                        <label for="ruleJson">GKD规则JSON</label>
                        <div class="paste-area">
                            <button class="btn btn-paste" onclick="pasteFromClipboard()">粘贴</button>
                            <div class="input-with-clear">
                                <textarea id="ruleJson" placeholder="请粘贴完整的GKD规则JSON"></textarea>
                                <button class="btn-clear" onclick="clearInput('ruleJson')">×</button>
                            </div>
                        </div>
                        <div class="helper-text">粘贴现有的GKD规则JSON，工具会自动解析并填充到表单中</div>
                    </div>
                    
                    <div class="deconstruct-example">
                        <strong>示例规则格式：</strong><br>
                        {<br>
                        &nbsp;&nbsp;"id": "com.example.app",<br>
                        &nbsp;&nbsp;"name": "开屏广告",<br>
                        &nbsp;&nbsp;"groups": [{<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;"key": 1,<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;"name": "开屏广告",<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;"rules": [{<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"matches": "[text='跳过'][id*='skip']",<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"action": "click"<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;}]<br>
                        &nbsp;&nbsp;}]<br>
                        }
                    </div>
                    
                    <button class="btn btn-deconstruct" onclick="deconstructRule()" style="margin-top: 15px;">
                        拆解规则
                    </button>
                </div>
                
                <!-- 使用说明标签页 - 只包含使用说明 -->
                <div id="help" class="tab-content">
                    <div class="help-content">
                        <h2>使用说明</h2>
                        
                        <div class="example">
                            <p><strong>如何使用生成的规则：</strong></p>
                            <p>1. 复制上方生成的规则代码</p>
                            <p>2. 在GKD应用中创建新的本地订阅文件</p>
                            <p>3. 将规则粘贴到文件中并保存</p>
                            <p>4. 在GKD中启用该订阅</p>
                        </div>
                        
                        <div class="example">
                            <p><strong>规则拆解功能</strong></p>
                            <p><strong>如何使用规则拆解功能：</strong></p>
                            <p>1. 在规则拆解标签页粘贴现有的GKD规则JSON</p>
                            <p>2. 点击"拆解规则"按钮</p>
                            <p>3. 工具会自动解析并填充到各表单字段</p>
                            <p>4. 可以在其他标签页中查看和修改填充的内容</p>
                        </div>
                        
                        <div class="example">
                            <p><strong>匹配规则编写技巧：</strong></p>
                            <p>• <strong>ID匹配</strong>: 使用元素的唯一资源ID，最精确</p>
                            <p>• <strong>文本匹配</strong>: 使用按钮上显示的文本</p>
                            <p>• <strong>复合匹配</strong>: 结合多个条件提高准确性</p>
                        </div>
                        
                        <div class="example">
                            <p><strong>高级功能说明</strong></p>
                            <p><strong>活动页面 (activityIds)</strong>: 指定规则生效的页面，可在快照中查看</p>
                            <p><strong>延迟执行 (actionDelay)</strong>: 单位毫秒，用于控制规则执行时机</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let currentTab = 'basic';
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.currentTarget.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
        }
        
        function nextTab() {
            const tabOrder = ['basic', 'matches', 'advanced', 'preview'];
            const currentIndex = tabOrder.indexOf(currentTab);
            if (currentIndex < tabOrder.length - 1) {
                const nextTab = tabOrder[currentIndex + 1];
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                const nextTabElement = document.querySelector(`.tab[onclick*="${nextTab}"]`);
                if (nextTabElement) {
                    nextTabElement.classList.add('active');
                }
                document.getElementById(nextTab).classList.add('active');
                currentTab = nextTab;
            }
        }
        
        function updateMatchHelper(selectElement) {
            const helper = selectElement.parentElement.nextElementSibling.querySelector('.match-helper');
            const value = selectElement.value;
            
            const helperTexts = {
                'id': '匹配元素的资源ID，如: com.example.ad/close',
                'text': '匹配元素显示的文本，如: 跳过广告',
                'desc': '匹配元素的描述内容，如: 关闭按钮',
                'complex': '使用复杂条件匹配，如: [id$="close"][text*="跳过"]'
            };
            
            helper.textContent = helperTexts[value] || '请输入匹配值';
        }
        
        function addMatchRule() {
            const matchRules = document.getElementById('match-rules');
            const newIndex = matchRules.children.length + 1;
            
            const newRule = document.createElement('div');
            newRule.className = 'match-rule';
            newRule.innerHTML = `
                <div class="match-header">
                    <div class="match-title">匹配规则 #${newIndex}</div>
                    <button class="remove-match" onclick="removeMatchRule(this)">删除</button>
                </div>
                <div class="form-group">
                    <label>匹配类型</label>
                    <select class="match-type" onchange="updateMatchHelper(this)">
                        <option value="id">ID匹配</option>
                        <option value="text">文本匹配</option>
                        <option value="desc">描述匹配</option>
                        <option value="complex">复合匹配</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>匹配值</label>
                    <div class="input-with-clear">
                        <input type="text" class="match-value" placeholder="根据匹配类型填写ID、文本或描述">
                        <button class="btn-clear" onclick="clearMatchValue(this)">×</button>
                    </div>
                    <div class="helper-text match-helper">匹配元素的资源ID，如: com.example.ad/close</div>
                </div>
            `;
            
            matchRules.appendChild(newRule);
        }
        
        function removeMatchRule(button) {
            if (document.getElementById('match-rules').children.length > 1) {
                button.closest('.match-rule').remove();
                // 重新编号
                document.querySelectorAll('.match-rule').forEach((rule, index) => {
                    rule.querySelector('.match-title').textContent = `匹配规则 #${index + 1}`;
                });
            } else {
                showToast('至少需要保留一条匹配规则', true);
            }
        }
        
        function clearInput(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = '';
                if (inputId === 'groupKey') {
                    input.value = '1'; // 默认值
                } else if (inputId === 'actionDelay') {
                    input.value = '0'; // 默认值
                }
            }
        }
        
        function clearMatchValue(button) {
            const input = button.parentElement.querySelector('input');
            if (input) {
                input.value = '';
            }
        }
        
        function pasteFromClipboard() {
            if (navigator.clipboard) {
                navigator.clipboard.readText().then(text => {
                    document.getElementById('ruleJson').value = text;
                    showToast('已从剪贴板粘贴内容');
                }).catch(err => {
                    showToast('无法读取剪贴板内容，请手动粘贴', true);
                });
            } else {
                showToast('浏览器不支持剪贴板API，请手动粘贴', true);
            }
        }
        
        function deconstructRule() {
            const ruleJsonText = document.getElementById('ruleJson').value;
            if (!ruleJsonText.trim()) {
                showToast('请输入要拆解的规则JSON', true);
                return;
            }
            
            try {
                const ruleData = JSON.parse(ruleJsonText);
                
                // 填充基本设置
                document.getElementById('appId').value = ruleData.id || '';
                document.getElementById('ruleName').value = ruleData.name || '';
                
                // 处理规则组
                if (ruleData.groups && ruleData.groups.length > 0) {
                    const group = ruleData.groups[0];
                    document.getElementById('groupKey').value = group.key || 1;
                    
                    // 处理activityIds
                    if (group.activityIds) {
                        document.getElementById('activityIds').value = Array.isArray(group.activityIds) 
                            ? group.activityIds.join('\n') 
                            : group.activityIds;
                    }
                    
                    // 处理规则
                    if (group.rules && group.rules.length > 0) {
                        // 清空现有匹配规则
                        const matchRulesContainer = document.getElementById('match-rules');
                        matchRulesContainer.innerHTML = '';
                        
                        // 添加规则
                        group.rules.forEach((rule, index) => {
                            if (index === 0) {
                                // 第一个规则，使用默认的第一个匹配规则项
                                addMatchRule();
                                const firstRule = matchRulesContainer.querySelector('.match-rule');
                                fillMatchRule(firstRule, rule);
                            } else {
                                addMatchRule();
                                const allRules = matchRulesContainer.querySelectorAll('.match-rule');
                                const newRule = allRules[allRules.length - 1];
                                fillMatchRule(newRule, rule);
                            }
                        });
                        
                        // 如果只有一个规则，确保有正确的编号
                        if (group.rules.length === 1) {
                            const firstRule = matchRulesContainer.querySelector('.match-rule');
                            firstRule.querySelector('.match-title').textContent = '匹配规则 #1';
                        }
                    }
                    
                    // 处理actionDelay（取第一个规则的）
                    if (group.rules && group.rules[0] && group.rules[0].actionDelay !== undefined) {
                        document.getElementById('actionDelay').value = group.rules[0].actionDelay;
                    }
                }
                
                showToast('规则拆解完成！表单已填充，规则已生成');
                // 生成规则
                generateRule();
                // 修改：跳转到基本设置标签而不是规则预览标签
                switchTab('basic');
                
            } catch (error) {
                showToast('JSON解析错误：' + error.message, true);
            }
        }
        
        function fillMatchRule(ruleElement, ruleData) {
            if (!ruleData.matches) return;
            
            const matches = ruleData.matches;
            let matchType = 'complex';
            let matchValue = matches;
            
            // 尝试解析匹配类型
            const idMatch = matches.match(/^\[id="([^"]+)"\]$/);
            const textMatch = matches.match(/^\[text="([^"]+)"\]$/);
            const descMatch = matches.match(/^\[desc="([^"]+)"\]$/);
            
            if (idMatch) {
                matchType = 'id';
                matchValue = idMatch[1];
            } else if (textMatch) {
                matchType = 'text';
                matchValue = textMatch[1];
            } else if (descMatch) {
                matchType = 'desc';
                matchValue = descMatch[1];
            }
            
            // 设置匹配类型和值
            const typeSelect = ruleElement.querySelector('.match-type');
            const valueInput = ruleElement.querySelector('.match-value');
            
            typeSelect.value = matchType;
            valueInput.value = matchValue;
            updateMatchHelper(typeSelect);
        }
        
        function generateRule() {
            // 获取基本设置
            const appId = document.getElementById('appId').value || 'com.example.app';
            const ruleName = document.getElementById('ruleName').value || '示例规则';
            const groupKey = document.getElementById('groupKey').value || 1;
            const actionDelay = document.getElementById('actionDelay').value || 0;
            
            // 获取activityIds
            const activityIdsText = document.getElementById('activityIds').value;
            const activityIds = activityIdsText ? activityIdsText.split('\n').filter(id => id.trim()) : [];
            
            // 获取匹配规则
            const matches = [];
            document.querySelectorAll('.match-rule').forEach(rule => {
                const type = rule.querySelector('.match-type').value;
                const value = rule.querySelector('.match-value').value;
                
                if (value) {
                    let matchRule = '';
                    switch(type) {
                        case 'id':
                            matchRule = `[id="${value}"]`;
                            break;
                        case 'text':
                            matchRule = `[text="${value}"]`;
                            break;
                        case 'desc':
                            matchRule = `[desc="${value}"]`;
                            break;
                        case 'complex':
                            matchRule = value;
                            break;
                    }
                    matches.push(matchRule);
                }
            });
            
            // 构建规则对象
            const ruleObject = {
                id: appId,
                name: ruleName,
                groups: [
                    {
                        key: parseInt(groupKey),
                        name: ruleName,
                        rules: [
                            {
                                matches: matches.length > 0 ? matches.join('&&') : '// 请添加匹配规则',
                                action: 'click',
                                actionDelay: parseInt(actionDelay)
                            }
                        ]
                    }
                ]
            };
            
            // 添加activityIds（如果有）
            if (activityIds.length > 0) {
                ruleObject.groups[0].activityIds = activityIds;
            }
            
            // 生成格式化的JSON5输出
            const output = formatRule(ruleObject);
            document.getElementById('preview-output').innerHTML = output;
            
            // 保存规则文本到全局变量，供复制使用
            window.currentRuleText = formatRuleText(ruleObject);
        }
        
        function formatRule(ruleObj) {
            let result = '<div class="output-line"><span class="field-comment">// GKD规则生成器创建的自定义规则</span></div>';
            result += '<div class="output-line"><span class="field-comment">// 生成时间: ' + new Date().toLocaleString() + '</span></div>';
            result += '<div class="output-line">{</div>';
            
            result += '<div class="output-line">  <span class="field-name">"id"</span>: <span class="field-value">"' + (ruleObj.id || '') + '"</span>,</div>';
            result += '<div class="output-line">  <span class="field-name">"name"</span>: <span class="field-value">"' + (ruleObj.name || '') + '"</span>,</div>';
            result += '<div class="output-line">  <span class="field-name">"groups"</span>: [</div>';
            result += '<div class="output-line">    {</div>';
            
            result += '<div class="output-line">      <span class="field-name">"key"</span>: <span class="field-value">' + (ruleObj.groups[0].key || 1) + '</span>,</div>';
            result += '<div class="output-line">      <span class="field-name">"name"</span>: <span class="field-value">"' + (ruleObj.groups[0].name || '') + '"</span>,</div>';
            
            if (ruleObj.groups[0].activityIds) {
                result += '<div class="output-line">      <span class="field-name">"activityIds"</span>: [</div>';
                ruleObj.groups[0].activityIds.forEach((id, index) => {
                    result += '<div class="output-line">        <span class="field-value">"' + id + '"</span>' + 
                             (index < ruleObj.groups[0].activityIds.length - 1 ? ',' : '') + '</div>';
                });
                result += '<div class="output-line">      ],</div>';
            }
            
            result += '<div class="output-line">      <span class="field-name">"rules"</span>: [</div>';
            result += '<div class="output-line">        {</div>';
            result += '<div class="output-line">          <span class="field-name">"matches"</span>: <span class="field-value">"' + (ruleObj.groups[0].rules[0].matches || '') + '"</span>,</div>';
            result += '<div class="output-line">          <span class="field-name">"action"</span>: <span class="field-value">"' + (ruleObj.groups[0].rules[0].action || 'click') + '"</span></div>';
            
            if (ruleObj.groups[0].rules[0].actionDelay > 0) {
                result += '<div class="output-line">          <span class="field-name">"actionDelay"</span>: <span class="field-value">' + ruleObj.groups[0].rules[0].actionDelay + '</span></div>';
            }
            
            result += '<div class="output-line">        }</div>';
            result += '<div class="output-line">      ]</div>';
            result += '<div class="output-line">    }</div>';
            result += '<div class="output-line">  ]</div>';
            result += '<div class="output-line">}</div>';
            
            return result;
        }
        
        function formatRuleText(ruleObj) {
            // 使用JSON.stringify生成紧凑的JSON，避免多余空格和换行
            return JSON.stringify(ruleObj, null, 0);
        }
        
        function copyPreviewRule() {
            if (!window.currentRuleText) {
                showToast('请先生成规则再复制', true);
                return;
            }
            
            // 直接使用window.currentRuleText，避免从HTML提取带来的格式问题
            const ruleText = window.currentRuleText;
            
            const textArea = document.createElement('textarea');
            textArea.value = ruleText;
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    showToast('预览规则已复制到剪贴板');
                } else {
                    showToast('复制失败，请手动复制', true);
                }
            } catch (err) {
                document.body.removeChild(textArea);
                
                // 使用现代Clipboard API作为备选方案
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(ruleText).then(() => {
                        showToast('预览规则已复制到剪贴板');
                    }).catch(() => {
                        showToast('复制失败，请手动复制', true);
                    });
                } else {
                    showToast('复制失败，请手动复制', true);
                }
            }
        }
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
